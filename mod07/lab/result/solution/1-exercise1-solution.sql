---------------------------------------------------------------------
-- LAB 07
--
-- Exercise 1
---------------------------------------------------------------------

---------------------------------------------------------------------
-- Task 1
-- 
-- Выполните код ниже для создания новой таблицы ExtraCustomers. 
---------------------------------------------------------------------

CREATE TABLE "public"."ExtraCustomers"(
	custid int GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) NOT NULL,
	fullname varchar(40) NOT NULL,
	city varchar(15) NOT NULL,
	country varchar(15) NOT NULL,
    discount numeric(4,2) NOT NULL,
CONSTRAINT PK_ECustomers PRIMARY KEY(custid)
); 


---------------------------------------------------------------------
-- Task 2
-- 
-- Напишите запрос на вставку одной записи в таблицу ExtraCustomers со следующей информацией:
-- 'Иван Иванов', 'Москва', 'Россия', 0.4

---------------------------------------------------------------------

INSERT INTO "public"."ExtraCustomers" (fullname, city, country, discount )
VALUES ('Иван Иванов', 'Москва', 'Россия', 0.4);

---------------------------------------------------------------------
-- Task 3
-- 
-- Напишите SELECT-запрос к таблице Sales.Customers, выводящий всех заказчиков из Германии и Франции.
-- Выведите только полное имя (вычисляемый столбец из companyname и contactname через двоеточие), город, страну. 
--
-- Результирующий набор сравните с Lab Exercise1 - Task3 Result.txt
---------------------------------------------------------------------

SELECT CONCAT(companyname, ': ', contactname) AS  fullname, city, country
FROM "Sales"."Customers"
WHERE country IN ('Germany', 'France');


---------------------------------------------------------------------
-- Task 4
-- 
-- Используя SELECT-запрос задания 3 вставьте данные в таблицу ExtraCustomers. Скидка у всех заказчиков одинаковая - 0,4
--
---------------------------------------------------------------------

INSERT INTO "public"."ExtraCustomers" (fullname, city, country, discount )
SELECT CONCAT(companyname, ': ', contactname) AS  fullname, city, country, 0.4
FROM "Sales"."Customers"
WHERE country IN ('Germany', 'France');


---------------------------------------------------------------------
-- Task 5
-- 
-- Обновите данные в таблице ExtraCustomers, определив скидку 0.3 для всех заказчиков из Парижа.
--
---------------------------------------------------------------------

UPDATE "public"."ExtraCustomers" 
SET discount = 0.3
WHERE city = 'Paris';

---------------------------------------------------------------------
-- Task 6
-- 
-- Удалите заказчика, созданного в Task2
--
---------------------------------------------------------------------

DELETE FROM "public"."ExtraCustomers"
WHERE custid = 1;


---------------------------------------------------------------------
-- Task 7
-- 
-- Скопируйте данные о продуктах дороже 50$ из таблицы Production.Products в несуществующую таблицу NewProducts.
-- Выполните написанный Вами запрос повторно. Что произошло?
---------------------------------------------------------------------

SELECT * INTO NewProducts
FROM "Production"."Products"
WHERE unitprice > 50::money;


---------------------------------------------------------------------
-- Task 8 *
-- 
-- Удалите некоторых заказчиков так, чтобы в таблице остались заказчики только по уникальным адресам (city, country).
-- Остаться должны заказчики с наименьшим custid

-- Если Вы все делали верно, то в таблице ExtraCustomers должно остаться 20 строк.
---------------------------------------------------------------------

DELETE FROM "public"."ExtraCustomers" as e1
USING 
 "public"."ExtraCustomers" as e2
WHERE e1.custid > e2.custid AND e2.city = e1.city and e2.country = e2.country;


-- Запросы для проверки

SELECT distinct country, city FROM "public"."ExtraCustomers";

SELECT * FROM "public"."ExtraCustomers";


---------------------------------------------------------------------
-- Task 9
-- 
-- Выполните код ниже для удаления таблицы ExtraCustomers
---------------------------------------------------------------------

DROP TABLE IF EXISTS "public"."ExtraCustomers";

